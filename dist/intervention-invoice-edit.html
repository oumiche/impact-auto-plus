<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modifier une Facture d'Intervention - Impact Auto</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/intervention-invoice-form.css">
    <link rel="stylesheet" href="css/notification.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="page-header">
            <div class="header-content">
                <div class="header-left">
                    <div class="header-text">
                        <h1>Modifier une Facture d'Intervention</h1>
                        <p>Modification de la facture</p>
                    </div>
                </div>
                <div class="header-right">
                    <button class="btn btn-secondary" @click="goBack">
                        <i class="fas fa-arrow-left"></i>
                        Retour
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div v-if="loading" class="loading-state">
            <div class="loading-spinner"></div>
            <p>Chargement de la facture...</p>
        </div>

        <!-- Invoice Form -->
        <div v-else class="invoice-form-container">
            <form @submit.prevent="submitForm" class="invoice-form">
                <!-- Invoice Information Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-file-invoice"></i>
                        <h3>Informations de la facture</h3>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Numéro de facture *</label>
                            <input 
                                type="text" 
                                v-model="invoice.invoiceNumber" 
                                class="form-control"
                                :class="{ 'is-invalid': errors.invoiceNumber }"
                                required
                                readonly
                            >
                            <div v-if="errors.invoiceNumber" class="invalid-feedback">{{ errors.invoiceNumber }}</div>
                        </div>
                        
                        <div class="form-group">
                            <label>Date de facture *</label>
                            <input 
                                type="date" 
                                v-model="invoice.invoiceDate" 
                                class="form-control"
                                :class="{ 'is-invalid': errors.invoiceDate }"
                                required
                            >
                            <div v-if="errors.invoiceDate" class="invalid-feedback">{{ errors.invoiceDate }}</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date d'échéance</label>
                            <input 
                                type="date" 
                                v-model="invoice.dueDate" 
                                class="form-control"
                                :class="{ 'is-invalid': errors.dueDate }"
                            >
                            <div v-if="errors.dueDate" class="invalid-feedback">{{ errors.dueDate }}</div>
                        </div>
                        
                        <div class="form-group">
                            <label>Statut de paiement</label>
                            <select 
                                v-model="invoice.paymentStatus" 
                                class="form-control"
                                :class="{ 'is-invalid': errors.paymentStatus }"
                            >
                                <option value="pending">En attente</option>
                                <option value="paid">Payé</option>
                            </select>
                            <div v-if="errors.paymentStatus" class="invalid-feedback">{{ errors.paymentStatus }}</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Méthode de paiement</label>
                            <input 
                                type="text" 
                                v-model="invoice.paymentMethod" 
                                class="form-control"
                                :class="{ 'is-invalid': errors.paymentMethod }"
                                placeholder="Espèces, Virement, Chèque..."
                            >
                            <div v-if="errors.paymentMethod" class="invalid-feedback">{{ errors.paymentMethod }}</div>
                        </div>
                        
                        <div class="form-group">
                            <label>Date de paiement</label>
                            <input 
                                type="datetime-local" 
                                v-model="invoice.paidAt" 
                                class="form-control"
                                :class="{ 'is-invalid': errors.paidAt }"
                                :disabled="invoice.paymentStatus !== 'paid'"
                            >
                            <div v-if="errors.paidAt" class="invalid-feedback">{{ errors.paidAt }}</div>
                        </div>
                    </div>
                </div>

                <!-- Intervention Information Section (Read-only) -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-tools"></i>
                        <h3>Intervention</h3>
                    </div>
                    
                    <div v-if="invoice.intervention" class="selected-intervention">
                        <div class="selected-info">
                            <strong>{{ invoice.intervention.interventionNumber }}</strong>
                            <span>{{ invoice.intervention.title }}</span>
                            <small>{{ invoice.intervention.vehicle.plateNumber }} - {{ invoice.intervention.vehicle.brand }} {{ invoice.intervention.vehicle.model }}</small>
                        </div>
                    </div>
                </div>

                <!-- Financial Information Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-calculator"></i>
                        <h3>Informations financières</h3>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Sous-total (HT) *</label>
                            <input 
                                type="number" 
                                step="0.01" 
                                v-model="invoice.subtotal" 
                                class="form-control"
                                :class="{ 'is-invalid': errors.subtotal }"
                                required
                            >
                            <div v-if="errors.subtotal" class="invalid-feedback">{{ errors.subtotal }}</div>
                        </div>
                        
                        <div class="form-group">
                            <label>Montant TVA *</label>
                            <input 
                                type="number" 
                                step="0.01" 
                                v-model="invoice.taxAmount" 
                                class="form-control"
                                :class="{ 'is-invalid': errors.taxAmount }"
                                required
                            >
                            <div v-if="errors.taxAmount" class="invalid-feedback">{{ errors.taxAmount }}</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Montant total (TTC) *</label>
                            <input 
                                type="number" 
                                step="0.01" 
                                v-model="invoice.totalAmount" 
                                class="form-control"
                                :class="{ 'is-invalid': errors.totalAmount }"
                                required
                                readonly
                            >
                            <div v-if="errors.totalAmount" class="invalid-feedback">{{ errors.totalAmount }}</div>
                        </div>
                        
                        <div class="form-group">
                            <label>Taux de TVA (%)</label>
                            <input 
                                type="number" 
                                step="0.01" 
                                v-model="taxRate" 
                                @input="calculateTax"
                                class="form-control"
                            >
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-sticky-note"></i>
                        <h3>Notes et commentaires</h3>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea 
                            v-model="invoice.notes" 
                            class="form-control"
                            :class="{ 'is-invalid': errors.notes }"
                            rows="4"
                            placeholder="Notes additionnelles sur la facture..."
                        ></textarea>
                        <div v-if="errors.notes" class="invalid-feedback">{{ errors.notes }}</div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions-bottom">
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" @click="goBack">
                            <i class="fas fa-times"></i>
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-primary" :disabled="!isFormValid || submitting">
                            <i v-if="submitting" class="fas fa-spinner fa-spin"></i>
                            <i v-else class="fas fa-save"></i>
                            {{ submitting ? 'Sauvegarde...' : 'Sauvegarder les modifications' }}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/vue.global.prod.js"></script>
    <script src="js/services/ApiService.js"></script>
    <script src="js/auth/auth-guard.js"></script>
    <script src="js/sidebar-component.js"></script>
    <script src="js/load-sidebar.js"></script>
    <script src="js/services/NotificationService.js"></script>
    <script src="js/intervention-invoice-form-vue.js"></script>

    <script>
        // Initialize Vue app
        const { createApp } = Vue;
        
        createApp(window.InterventionInvoiceFormApp, {
            mode: 'edit'
        }).mount('#app');
    </script>
</body>
</html>
